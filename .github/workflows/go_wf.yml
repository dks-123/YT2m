name: Auto Update File to GitHub

on:
  schedule:
    # æ¸›å°‘åŸ·è¡Œé »ç‡ï¼Œé¿å…è§¸ç™¼ YouTube é˜²è­·æ©Ÿåˆ¶
  workflow_dispatch:

jobs:
  update_m3u8:
    runs-on: ubuntu-latest
    env:
      SF_L: ${{ secrets.SF_L }}
      YT_API_KEY: ${{ secrets.YT_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: pip install -U httpx[http2] paramiko

      - name: ğŸ” Combine Base64 cookie segments into cookies.b64 (optional)
        run: |
          if [ ! -z "${{ secrets.YT_COOKIE_B64_P1 }}" ]; then
            echo "${{ secrets.YT_COOKIE_B64_P1 }}" > cookies.b64
            echo "${{ secrets.YT_COOKIE_B64_P2 }}" >> cookies.b64
            echo "${{ secrets.YT_COOKIE_B64_P3 }}" >> cookies.b64
            echo "âœ… cookies.b64 çµ„åˆå®Œæˆ"
          else
            echo "â„¹ï¸ æœªè¨­ç½® Cookieï¼Œå°‡ä½¿ç”¨ç„¡ Cookie æ¨¡å¼"
          fi

      - name: ğŸ“„ Decode cookies.b64 into cookies.txt (optional)
        run: |
          if [ -f "cookies.b64" ]; then
            base64 -d cookies.b64 > cookies.txt
            echo "âœ… cookies.txt å·²ç”Ÿæˆ"
          else
            echo "â„¹ï¸ è·³é cookies.txt ç”Ÿæˆ"
          fi

      - name: ğŸ” Run yt_m.py to parse M3U8 with retry mechanism
        run: |
          echo "ğŸš€ åŸ·è¡Œ scripts/yt_m.py"
          
          # è¨­å®šæœ€å¤§é‡è©¦æ¬¡æ•¸
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ğŸ”„ ç¬¬ $i æ¬¡å˜—è©¦..."
            
            # æ·»åŠ éš¨æ©Ÿå»¶é²é¿å…è¢«åµæ¸¬
            sleep $((RANDOM % 5 + 1))
            
            if python3 scripts/yt_m.py; then
              echo "âœ… ç¬¬ $i æ¬¡å˜—è©¦æˆåŠŸï¼"
              break
            else
              echo "âš ï¸ ç¬¬ $i æ¬¡å˜—è©¦å¤±æ•—"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾… $RETRY_DELAY ç§’å¾Œé‡è©¦..."
                sleep $RETRY_DELAY
                # å¢åŠ é‡è©¦é–“éš”
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "âŒ æ‰€æœ‰é‡è©¦å‡å¤±æ•—"
                exit 1
              fi
            fi
          done

      - name: ğŸ§¹ Clean up cookies.txt
        run: |
          rm -f cookies.txt cookies.b64
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“Š Generate execution report
        run: |
          echo "ğŸ“Š åŸ·è¡Œå ±å‘Š" >> execution_report.txt
          echo "æ™‚é–“: $(date)" >> execution_report.txt
          echo "è™•ç†çš„æ–‡ä»¶æ•¸é‡: $(ls -1 output/ | wc -l)" >> execution_report.txt
          echo "ç”Ÿæˆçš„æ–‡ä»¶:" >> execution_report.txt
          ls -la output/ >> execution_report.txt
          cat execution_report.txt

      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [[ -n "$(git status --porcelain output/)" ]]; then
            echo "ğŸ“‚ åµæ¸¬åˆ° output è®Šæ›´ï¼Œé–‹å§‹æäº¤..."
            git add output/
            
            # ç”Ÿæˆè©³ç´°çš„æäº¤è¨Šæ¯
            COMMIT_MSG="ğŸ”„ æ›´æ–° M3U8 æ–‡ä»¶ $(date '+%Y-%m-%d %H:%M:%S')"
            COMMIT_MSG="$COMMIT_MSG\n\nğŸ“Š çµ±è¨ˆè³‡è¨Š:"
            COMMIT_MSG="$COMMIT_MSG\n- è™•ç†æ–‡ä»¶æ•¸: $(ls -1 output/ | wc -l)"
            COMMIT_MSG="$COMMIT_MSG\n- åŸ·è¡Œæ™‚é–“: $(date)"
            
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… è®Šæ›´å·²æäº¤è‡³ GitHub"
          else
            echo "â„¹ï¸ output ç›®éŒ„æ²’æœ‰è®Šæ›´ï¼Œä¸é€²è¡Œæäº¤"
          fi

      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ å·¥ä½œæµç¨‹åŸ·è¡Œå¤±æ•—"
          echo "è«‹æª¢æŸ¥ä»¥ä¸‹å¯èƒ½çš„å•é¡Œï¼š"
          echo "1. YouTube API é…é¡æ˜¯å¦ç”¨ç›¡"
          echo "2. Cookie æ˜¯å¦éœ€è¦æ›´æ–°"
          echo "3. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸"
          echo "4. SFTP æ†‘è­‰æ˜¯å¦æ­£ç¢º"
